---
title: "new"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = TRUE
)
q <- 0
```

```{r setup, include=FALSE}
library(tidyverse)
library(tidycensus)
library(patchwork)
library(ggthemes)
library(rvest)
library(janitor)
library(lubridate)
library(httr2)
library(spotifyr)
library(purrr)
```

# What is the Average Number of Tracks per Album by Release Year
```{r}
album_ids <- c(
  "5H7ixXZfsNMGbIE5OBSpcb",  # THE TORTURED POETS DEPARTMENT: THE ANTHOLOGY by Taylor Swift 
  "7aJuG4TFXa2hmE4z1yxc3n",
  "3iPSVi54hsacKKl1xIR2eH",
  "4kS7bSuU0Jm9LYMosFU2x5",
  "5EYKrEDnKhhcNxGedaRQeK",
  "64LU4c1nfjz1t4VnGhagcg",
  "07w0rG5TETcyihsEIZR3qG",
  "1NAmidJlEaVgA3MpcPFYGq",
  "168CdR21lfn0TTyw1Pkdcm",
  "2ODvWsOgouMbaA5xf0RkJe")

# Function to get album data
get_albums_data <- function(album_ids) {
  req <- request("https://api.spotify.com/v1/albums") |>
    req_url_query(ids = paste(album_ids, collapse = ",")) |>
    req_headers(Authorization = paste("Bearer", token))

  resp <- req_perform(req)

  albums <- resp |>
    resp_body_json(simplifyVector = FALSE) |>
    (\(x) x$albums)()

  map_dfr(albums, function(album) {
    tibble(
      album_id = album$id,
      album_name = album$name,
      artist_id = album$artists[[1]]$id,
      artist_name = album$artists[[1]]$name,
      release_date = ymd(album$release_date),
      total_tracks = album$total_tracks
    )
  })
}

album_data <- get_albums_data(album_ids)
```

```{r}
# Ensure release year column exists
album_data |>
  mutate(release_year = year(release_date)) |>
  filter(!is.na(release_year), !is.na(total_tracks)) |>
  group_by(release_year) |>
  summarise(
    avg_tracks = mean(total_tracks, na.rm = TRUE),
    n_albums = n()
  ) |>
  ggplot(aes(x = release_year, y = avg_tracks)) +
  geom_line(color = "#1DB954", size = 1.2) +
  geom_point(color = "#1DB954", size = 2) +
  theme_minimal() +
  labs(
    title = "Average Number of Tracks per Album by Release Year",
    x = "Release Year",
    y = "Average Number of Tracks",
    caption = "Source: Spotify Web API"
  )
```

# How do release dates of top albums relate to their successâ€”do albums released earlier in the year perform better on year-end charts?
```{r}
library(lubridate)

album_data2 <- album_data2 %>%
  mutate(
    release_date = ymd(release_date),
    release_month = month(release_date),
    release_day_of_year = yday(release_date)
  )

get_album_popularity <- function(album_id) {
  req <- request(paste0("https://api.spotify.com/v1/albums/", album_id)) %>%
    req_headers(Authorization = paste("Bearer", token))
  resp <- req_perform(req)
  album_info <- resp_body_json(resp, simplifyVector = TRUE)
  return(album_info$popularity)
}

album_data2 <- album_data2 %>%
  rowwise() %>%
  mutate(popularity = get_album_popularity(album_id)) %>%
  ungroup()

library(ggplot2)

ggplot(album_data2, aes(x = release_day_of_year, y = popularity)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    title = "Album Popularity vs. Release Date (Day of Year)",
    x = "Release Date (Day of Year)",
    y = "Album Popularity Score"
  )
```








```{r}
multi_albums_artists <- album_data2 %>%
  count(artist_name) %>%
  pull(artist_name)

multi_album_data <- album_data2 %>%
  filter(artist_name %in% multi_albums_artists)
```

```{r}
library(lubridate)

multi_album_data <- multi_album_data %>%
  mutate(
    release_date = ymd(release_date),
    release_month = month(release_date),
    release_quarter = quarter(release_date),
    release_day_of_year = yday(release_date)
  )
```

```{r}
library(ggplot2)

ggplot(multi_album_data, aes(x = release_month, y = artist_name)) +
  geom_point(size = 4) +
  labs(title = "Release Months of Multiple Albums per Artist",
       x = "Release Month", y = "Artist") +
  theme_minimal()
```
```{r}
track_stats <- multi_album_data %>%
  group_by(artist_name) %>%
  summarise(
    mean_tracks = mean(total_tracks, na.rm = TRUE),
    sd_tracks = sd(total_tracks, na.rm = TRUE),
    n_albums = n()
  )
```


# "Which artists have the most tracks in top playlists, and how do their popularity and follower counts compare?"
```{r}
library(ggplot2)

# Count tracks per artist
top_artists <- all_tracks %>%
  count(artist_name, artist_id, sort = TRUE)

# Plot top 10 artists by number of tracks
top_artists %>%
  slice_max(n, n = 10) %>%
  ggplot(aes(x = reorder(artist_name, n), y = n, fill = artist_name)) +
  geom_col(show.legend = FALSE) +
  coord_flip() +
  labs(
    title = "Top 10 Artists by Track Count in Playlist",
    x = "Artist",
    y = "Number of Tracks"
  ) +
  theme_minimal()
```
```{r}
# Merge artist metadata with track count
artist_summary <- top_artists %>%
  left_join(artists_data, by = "artist_id")

# Scatter plot
ggplot(artist_summary, aes(x = followers, y = popularity, size = n, color = artist_name.x)) +
  geom_point(alpha = 0.8, show.legend = FALSE) +
  scale_x_log10(labels = scales::label_comma()) +
  labs(
    title = "Artist Popularity vs Followers",
    subtitle = "Bubble size = Number of Tracks in Playlist",
    x = "Followers (log scale)",
    y = "Popularity"
  ) +
  theme_minimal()
```

