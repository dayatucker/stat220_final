---
title: "artists_graphs"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(httr2)
library(plotly)
library(DT)
library(httr)
library(stringr)
```

```{r}
# API Setup
client_id <- readLines("spotify_client_id.txt")
client_secret <- readLines("spotify_client_secret.txt")

get_spotify_token <- function(client_id, client_secret) {
  resp <- request("https://accounts.spotify.com/api/token") |>
    req_auth_basic(client_id, client_secret) |>
    req_body_form(grant_type = "client_credentials") |>
    req_method("POST") |>
    req_perform()
  
  resp_body_json(resp)$access_token
}

token <- get_spotify_token(client_id, client_secret)
```

```{r}
# Function to get the artist and other information
get_artists_data <- function(artist_ids, token) {
  artist_chunks <- split(artist_ids, ceiling(seq_along(artist_ids) / 50))
  
  map_dfr(artist_chunks, function(ids_chunk) {
    req <- request("https://api.spotify.com/v1/artists") |>
      req_url_query(ids = paste(ids_chunk, collapse = ",")) |>
      req_headers(Authorization = paste("Bearer", token))
    
    resp <- req_perform(req)
    content <- resp_body_json(resp, simplifyVector = FALSE)
    
    map_dfr(content$artists, function(artist) {
      tibble(
        artist_id = artist$id,
        artist_name = artist$name,
        genres = paste(artist$genres, collapse = ", "),
        popularity = artist$popularity,
        followers = artist$followers$total,
        artist_url = artist$external_urls$spotify
      )
    })
  })
}

# Function to include the top tracks of the artists
get_artist_top_tracks <- function(artist_id, token) {
  url <- paste0("https://api.spotify.com/v1/artists/", artist_id, "/top-tracks?market=US")
  
  req <- request(url) |>
    req_headers(Authorization = paste("Bearer", token))
  
  resp <- req_perform(req)
  content <- resp_body_json(resp, simplifyVector = FALSE)
  
  map_dfr(content$tracks, function(track) {
    tibble(
      track_name = track$name,
      album_name = track$album$name,
      popularity = track$popularity,
      track_duration_ms = track$duration_ms,
      explicit = track$explicit,
      artist_id = artist_id
    )
  })
}
```

```{r}
# Function to create multiple datasets by year of the top tracks from top artists
merge_artist_data <- function(artist_ids){
  artists_data_temp <- get_artists_data(artist_ids, token)
  all_tracks_temp <- map_dfr(artist_ids, get_artist_top_tracks, token = token)
  return(left_join(all_tracks_temp, artists_data_temp |> select(artist_id, artist_name), by = "artist_id"))
}
```


```{r artist_id_lists}
artist_ids_2018 <- c(
  "3TVXtAsR1Inumwj472S9r4", # Drake
  "246dkjvS1zLTtiykXe5h60", # Post Malone
  "15UsOTVnJzReFVN1VCnxy4", # XXXTENTACION
  "1vyhD5VmyZ7KMfW5gqLgo5", # J Balvin
  "6eUKZXaKkcviH0Ku9w2n3V"  # Ed Sheeran
)

artist_ids_2019 <- c(
  "246dkjvS1zLTtiykXe5h60", # Post Malone
  "6eUKZXaKkcviH0Ku9w2n3V", # Ed Sheeran
  "6qqNVTkY8uBg9cP3Jd7DAH", # Billie Eilish
  "66CXWjxzNUsdJxJ2JdwvnR", # Ariana Grande
  "4q3ewBCX7sLwd24euuV69X"  # Bad Bunny
)

artist_ids_2020 <- c(
  "4q3ewBCX7sLwd24euuV69X", # Bad Bunny
  "3TVXtAsR1Inumwj472S9r4", # Drake
  "1vyhD5VmyZ7KMfW5gqLgo5", # J Balvin
  "4MCBfE4596Uoi2O4DtmEMz", # Juice WRLD
  "1Xyo4u8uXC1ZmMpatF05PJ"  # The Weeknd
)

artist_ids_2021 <- c(
  "4q3ewBCX7sLwd24euuV69X",  # Bad Bunny
  "06HL4z0CvFAxyc27GXpf02",  # Taylor Swift
  "3Nrfpe0tUJi4K4DXYWgMUX",  # BTS
  "3TVXtAsR1Inumwj472S9r4",  # Drake
  "1uNFoZAHBGtllmzznpCI3s"   # Justin Bieber
)

artist_ids_2022 <- c(
  "4q3ewBCX7sLwd24euuV69X",  # Bad Bunny
  "06HL4z0CvFAxyc27GXpf02",  # Taylor Swift
  "3TVXtAsR1Inumwj472S9r4",  # Drake
  "1Xyo4u8uXC1ZmMpatF05PJ",  # The Weeknd
  "3Nrfpe0tUJi4K4DXYWgMUX"   # BTS
)

artist_ids_2023 <- c(
  "06HL4z0CvFAxyc27GXpf02",  # Taylor Swift
  "4q3ewBCX7sLwd24euuV69X",  # Bad Bunny
  "1Xyo4u8uXC1ZmMpatF05PJ",  # The Weeknd
  "3TVXtAsR1Inumwj472S9r4",  # Drake
  "12GqGscKJx3aE4t07u7eVZ",  # Peso Pluma
  "2LRoIwlKmHjgvigdNGBHNo",  # Feid
  "0Y5tJX1MQlPlqiwlOH1tJY",  # Travis Scott
  "7tYKF4w9nC0nq9CsPZTHyP",  # SZA
  "790FomKkXshlbRYZFtlgla",  # Karol G
  "00FQb4jTyendYWaN8pK0wa"   # Lana Del Rey
)

artist_ids_2024 <- c(
  "06HL4z0CvFAxyc27GXpf02",  # Taylor Swift
  "1Xyo4u8uXC1ZmMpatF05PJ",  # The Weeknd
  "4q3ewBCX7sLwd24euuV69X",  # Bad Bunny
  "3TVXtAsR1Inumwj472S9r4",  # Drake
  "6qqNVTkY8uBg9cP3Jd7DAH",  # Billie Eilish
  "0Y5tJX1MQlPlqiwlOH1tJY",  # Travis Scott
  "12GqGscKJx3aE4t07u7eVZ",  # Peso Pluma
  "5K4W6rqBFWDnAN6FQUkS6x",  # Kanye West
  "66CXWjxzNUsdJxJ2JdwvnR",  # Ariana Grande
  "2LRoIwlKmHjgvigdNGBHNo"   # Feid
)

```

```{r}
# Merge track data with artist names
  all_tracks_2018 <- merge_artist_data(artist_ids_2018)
  all_tracks_2019 <- merge_artist_data(artist_ids_2019)
  all_tracks_2020 <- merge_artist_data(artist_ids_2020)
  all_tracks_2021 <- merge_artist_data(artist_ids_2021)
  all_tracks_2022 <- merge_artist_data(artist_ids_2022)
  all_tracks_2023 <- merge_artist_data(artist_ids_2023)
  all_tracks_2024 <- merge_artist_data(artist_ids_2024)

# Combine all years
  combined_tracks <- bind_rows(
    all_tracks_2018,
    all_tracks_2019,
    all_tracks_2020,
    all_tracks_2021,
    all_tracks_2022,
    all_tracks_2023,
    all_tracks_2024
  )
```


# Graph that will include a dropdown menu for the user to select an artist. It will display the artist's top tracks and if the track is explicit or not.
```{r}
# Example: Pick an artist
selected_artist <- "Drake"

# Filter tracks for the selected artist
artist_top_tracks <- combined_tracks |>
  filter(artist_name == selected_artist) |>
  distinct(track_name, .keep_all = TRUE)

# Create ggplot with custom text for tooltip
artist_tracks_plot <- ggplot(
  artist_top_tracks,
  aes(
    x = fct_reorder(track_name, popularity),
    y = popularity,
    fill = ifelse(explicit, "Explicit", "Non-Explicit"),
    text = str_c(
      "Track: ", track_name, "\n",
      "Popularity: ", popularity, "\n",
      "Explicit: ", ifelse(explicit, "Yes", "No")
    )
  )
) +
  geom_col(show.legend = TRUE) +
  theme_minimal() +
  labs(
    title = paste("Top Tracks by", selected_artist),
    x = "Track Name",
    y = "Popularity",
    fill = "Track Type"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# Convert to Plotly
ggplotly(artist_tracks_plot, tooltip = "text")
```




```{r}
# Example: Pick an artist
selected_artist <- "Taylor Swift"

# Filter unique tracks for the selected artist
top_tracks_duration <- combined_tracks |>
  filter(artist_name == selected_artist) |>
  distinct(track_name, .keep_all = TRUE) |>
  mutate(duration_min = track_duration_ms / 60000)

# Plot of popularity vs duration for the selected artist
top_tracks_duration_plot <- ggplot(
  top_tracks_duration,
  aes(
    x = duration_min,
    y = popularity,
    text = str_c(
      "Track: ", track_name, "\n",
      "Duration: ", round(duration_min, 2), " min\n",
      "Popularity: ", popularity, "\n"
    )
  )
) +
  geom_point(color = "orange", size = 4, alpha = 0.8) +
  theme_minimal() +
  labs(
    title = paste("Popularity vs Duration for", selected_artist),
    x = "Duration (minutes)",
    y = "Popularity"
  )

# Convert to Plotly
ggplotly(top_tracks_duration_plot, tooltip = "text")
```

