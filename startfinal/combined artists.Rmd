---
title: "final"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(httr2)
library(plotly)
library(DT)
library(httr)
```

```{r}
client_id <- readLines("spotify_client_id.txt")
client_secret <- readLines("spotify_client_secret.txt")

get_spotify_token <- function(client_id, client_secret) {
  resp <- request("https://accounts.spotify.com/api/token") |>
    req_auth_basic(client_id, client_secret) |>
    req_body_form(grant_type = "client_credentials") |>
    req_method("POST") |>
    req_perform()
  
  resp_body_json(resp)$access_token
}

token <- get_spotify_token(client_id, client_secret)
```

```{r}
get_artists_data <- function(artist_ids, token) {
  artist_chunks <- split(artist_ids, ceiling(seq_along(artist_ids) / 50))
  
  map_dfr(artist_chunks, function(ids_chunk) {
    req <- request("https://api.spotify.com/v1/artists") |>
      req_url_query(ids = paste(ids_chunk, collapse = ",")) |>
      req_headers(Authorization = paste("Bearer", token))
    
    resp <- req_perform(req)
    content <- resp_body_json(resp, simplifyVector = FALSE)
    
    map_dfr(content$artists, function(artist) {
      tibble(
        artist_id = artist$id,
        artist_name = artist$name,
        genres = paste(artist$genres, collapse = ", "),
        popularity = artist$popularity,
        followers = artist$followers$total,
        artist_url = artist$external_urls$spotify
      )
    })
  })
}

get_artist_top_tracks <- function(artist_id, token) {
  url <- paste0("https://api.spotify.com/v1/artists/", artist_id, "/top-tracks?market=US")
  
  req <- request(url) |>
    req_headers(Authorization = paste("Bearer", token))
  
  resp <- req_perform(req)
  content <- resp_body_json(resp, simplifyVector = FALSE)
  
  map_dfr(content$tracks, function(track) {
    tibble(
      track_name = track$name,
      album_name = track$album$name,
      popularity = track$popularity,
      track_duration_ms = track$duration_ms,
      explicit = track$explicit,
      artist_id = artist_id
    )
  })
}
```


```{r}
artist_ids_2018 <- c(
  "3TVXtAsR1Inumwj472S9r4", # Drake
  "246dkjvS1zLTtiykXe5h60", # Post Malone
  "15UsOTVnJzReFVN1VCnxy4", # XXXTENTACION
  "1vyhD5VmyZ7KMfW5gqLgo5", # J Balvin
  "6eUKZXaKkcviH0Ku9w2n3V"  # Ed Sheeran
  
  
)

artists_data_2018 <- get_artists_data(artist_ids_2018, token)
all_tracks_2018 <- map_dfr(artist_ids_2018, get_artist_top_tracks, token = token)

# Merge track data with artist names
all_tracks_2018 <- left_join(all_tracks_2018, artists_data_2018 |> select(artist_id, artist_name), by = "artist_id")

artist_ids_2019 <- c(
  "246dkjvS1zLTtiykXe5h60", # Post Malone
  "6eUKZXaKkcviH0Ku9w2n3V", # Ed Sheeran
  "6qqNVTkY8uBg9cP3Jd7DAH", # Billie Eilish
  "66CXWjxzNUsdJxJ2JdwvnR", # Ariana Grande
  "4q3ewBCX7sLwd24euuV69X"  # Bad Bunny
  
  
)

artists_data_2019 <- get_artists_data(artist_ids_2019, token)
all_tracks_2019 <- map_dfr(artist_ids_2019, get_artist_top_tracks, token = token)

# Merge track data with artist names
all_tracks_2019 <- left_join(all_tracks_2019, artists_data_2019 |> select(artist_id, artist_name), by = "artist_id")

artist_ids_2020 <- c(
  "4q3ewBCX7sLwd24euuV69X", # Bad Bunny
  "3TVXtAsR1Inumwj472S9r4", # Drake
  "1vyhD5VmyZ7KMfW5gqLgo5", # J Balvin
  "4MCBfE4596Uoi2O4DtmEMz", # Juice WRLD
  "1Xyo4u8uXC1ZmMpatF05PJ"  # The Weeknd
)

artists_data_2020 <- get_artists_data(artist_ids_2020, token)
all_tracks_2020 <- map_dfr(artist_ids_2020, get_artist_top_tracks, token = token)

# Merge track data with artist names
all_tracks_2020 <- left_join(all_tracks_2020, artists_data_2020 |> select(artist_id, artist_name), by = "artist_id")
```

```{r}
# 2021
artist_ids_2021 <- c(
  "4q3ewBCX7sLwd24euuV69X",  # Bad Bunny
  "06HL4z0CvFAxyc27GXpf02",  # Taylor Swift
  "3Nrfpe0tUJi4K4DXYWgMUX",  # BTS
  "3TVXtAsR1Inumwj472S9r4",  # Drake
  "1uNFoZAHBGtllmzznpCI3s"   # Justin Bieber
)

artists_data_2021 <- get_artists_data(artist_ids_2021, token)
all_tracks_2021 <- map_dfr(artist_ids_2022, get_artist_top_tracks, token = token)

# Merge track data with artist names
all_tracks_2021 <- left_join(all_tracks_2021, artists_data_2021 |> select(artist_id, artist_name), by = "artist_id")
```

```{r}
# 2022
artist_ids_2022 <- c(
  "4q3ewBCX7sLwd24euuV69X",  # Bad Bunny
  "06HL4z0CvFAxyc27GXpf02",  # Taylor Swift
  "3TVXtAsR1Inumwj472S9r4",  # Drake
  "1Xyo4u8uXC1ZmMpatF05PJ",  # The Weeknd
  "3Nrfpe0tUJi4K4DXYWgMUX"   # BTS
)

artists_data_2022 <- get_artists_data(artist_ids_2022, token)
all_tracks_2022 <- map_dfr(artist_ids_2022, get_artist_top_tracks, token = token)

# Merge track data with artist names
all_tracks_2022 <- left_join(all_tracks_2022, artists_data_2022 |> select(artist_id, artist_name), by = "artist_id")
```


```{r}
# 2023
artist_ids_2023 <- c(
  "06HL4z0CvFAxyc27GXpf02",  # Taylor Swift
  "4q3ewBCX7sLwd24euuV69X",  # Bad Bunny
  "1Xyo4u8uXC1ZmMpatF05PJ",  # The Weeknd
  "3TVXtAsR1Inumwj472S9r4",  # Drake
  "12GqGscKJx3aE4t07u7eVZ",  # Peso Pluma
  "2LRoIwlKmHjgvigdNGBHNo",  # Feid
  "0Y5tJX1MQlPlqiwlOH1tJY",  # Travis Scott
  "7tYKF4w9nC0nq9CsPZTHyP",  # SZA
  "790FomKkXshlbRYZFtlgla",  # Karol G
  "00FQb4jTyendYWaN8pK0wa"   # Lana Del Rey
)

artists_data_2023 <- get_artists_data(artist_ids_2023, token)
all_tracks_2023 <- map_dfr(artist_ids_2023, get_artist_top_tracks, token = token)

# Merge track data with artist names
all_tracks_2023 <- left_join(all_tracks_2023, artists_data_2023 |> select(artist_id, artist_name), by = "artist_id")
```

```{r}
# 2024
artist_ids_2024 <- c(
  "06HL4z0CvFAxyc27GXpf02",  # Taylor Swift
  "1Xyo4u8uXC1ZmMpatF05PJ",  # The Weeknd
  "4q3ewBCX7sLwd24euuV69X",  # Bad Bunny
  "3TVXtAsR1Inumwj472S9r4",  # Drake
  "6qqNVTkY8uBg9cP3Jd7DAH",  # Billie Eilish
  "0Y5tJX1MQlPlqiwlOH1tJY",  # Travis Scott
  "12GqGscKJx3aE4t07u7eVZ",  # Peso Pluma
  "5K4W6rqBFWDnAN6FQUkS6x",  # Kanye West
  "66CXWjxzNUsdJxJ2JdwvnR",  # Ariana Grande
  "2LRoIwlKmHjgvigdNGBHNo"   # Feid
)

artists_data_2024 <- get_artists_data(artist_ids_2024, token)
all_tracks_2024 <- map_dfr(artist_ids_2024, get_artist_top_tracks, token = token)

# Merge track data with artist names
all_tracks_2024 <- left_join(all_tracks_2024, artists_data_2024 |> select(artist_id, artist_name), by = "artist_id")
```


```{r}
# Combine all years
combined_tracks <- bind_rows(
  all_tracks_2021,
  all_tracks_2022,
  all_tracks_2023,
  all_tracks_2024
)
```

```{r}
# Get most popular track(s) per artist
most_popular_tracks <- combined_tracks |>
  filter(!is.na(artist_name)) |>
  group_by(artist_name) |>
  slice_max(order_by = popularity, n = 1) |>  # keep ties by default
  ungroup() |>
  mutate(popularity = as.numeric(popularity))

popular_tracks_plot <- ggplot(
  most_popular_tracks,
  aes(
    x = fct_reorder(track_name, popularity),
    y = popularity,
    fill = artist_name,
    text = paste0(
      "Artist: ", artist_name, "\n",
      "Track: ", track_name, "\n",
      "Popularity: ", popularity, "\n",
      "Explicit: ", ifelse(explicit, "Yes", "No")
    )
  )
) +
  geom_col(position = "dodge") +
  theme_minimal() +
  labs(
    title = "Most Popular Track(s) from Each Top Artist",
    x = "Track Name",
    y = "Popularity",
    fill = "Artist"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggplotly(popular_tracks_plot, tooltip = "text")
```

