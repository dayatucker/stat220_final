---
title: "finalprojstart"
output: html_document
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  echo = TRUE
)
q <- 0
```

```{r setup, include=FALSE}
library(tidyverse)
library(tidycensus)
library(ggthemes)
library(rvest)
library(janitor)
library(lubridate)
library(httr2)
library(purrr)
library(plotly)
library(shiny)
library(spotifyr)
```

```{r}
client_id <- readLines("spotify_client_id.txt")
client_secret <- readLines("spotify_client_secret.txt")

get_spotify_token <- function(client_id, client_secret) {
  resp <- request("https://accounts.spotify.com/api/token") |>
    req_auth_basic(client_id, client_secret) |>
    req_body_form(grant_type = "client_credentials") |>
    req_method("POST") |>
    req_perform()
  
  resp_body_json(resp)$access_token
}

token <- get_spotify_token(client_id, client_secret)
```


# Top Hit Playlists
```{r}
get_playlist_tracks <- function(playlist_id, token) {
  url <- paste0("https://api.spotify.com/v1/playlists/", playlist_id, "/tracks")
  
  req <- request(url) |>
    req_headers(Authorization = paste("Bearer", token))
  
  resp <- req_perform(req)
  
  content <- resp_body_json(resp, simplifyVector = FALSE)
  
  tracks <- content$items

  map_dfr(tracks, function(item) {
    track <- item$track
    tibble(
      track_id = track$id,
      track_name = track$name,
      album_id = track$album$id,
      album_name = track$album$name,
      artist_id = track$artists[[1]]$id,
      artist_name = track$artists[[1]]$name,
      track_duration_ms = track$duration_ms,
      track_explicit = track$explicit,
      added_at = ymd_hms(item$added_at),
      album_release_date = track$album$release_date,
      popularity = track$popularity
    )
  })
}
```

```{r}
playlist_2014 <- "5oN9E0LneOjbrYkGrZmUc9"
playlist_tracks_2014 <- get_playlist_tracks(playlist_2014, token)

playlist_2015 <- "4xYPZBwLtndo3MqjM0kMz1"
playlist_tracks_2015 <- get_playlist_tracks(playlist_2015, token)

playlist_2016 <- "0MvxEHiGaSFsKXry6Vjvb1"
playlist_tracks_2016 <- get_playlist_tracks(playlist_2016, token)

playlist_2017 <- "0cNzbPLBSPIFUrJkqxkmUw"
playlist_tracks_2017 <- get_playlist_tracks(playlist_2017, token)

playlist_2018 <- "5l771HfZDqlBsDFQzO0431"
playlist_tracks_2018 <- get_playlist_tracks(playlist_2018, token)

# playlist_2019 <- "37i9dQZF1DWVRSukIED0e9"
# playlist_tracks_2019 <- get_playlist_tracks(playlist_2019, token)

playlist_2020 <- "2fmTTbBkXi8pewbUvG3CeZ"
playlist_tracks_2020 <- get_playlist_tracks(playlist_2020, token)

playlist_2021 <- "5GhQiRkGuqzpWZSE7OU4Se"
playlist_tracks_2021 <- get_playlist_tracks(playlist_2021, token)

playlist_2022 <- "56r5qRUv3jSxADdmBkhcz7"
playlist_tracks_2022 <- get_playlist_tracks(playlist_2022, token)

playlist_2023 <- "6unJBM7ZGitZYFJKkO0e4P"
playlist_tracks_2023 <- get_playlist_tracks(playlist_2023, token)

playlist_2024 <- "774kUuKDzLa8ieaSmi8IfS"
playlist_tracks_2024 <- get_playlist_tracks(playlist_2024, token)

playlist_2025 <- "5mCL9f0hUeCm49FFPY8JGn"
playlist_tracks_2025 <- get_playlist_tracks(playlist_2025, token)
```


```{r}
playlist_tracks_2014$playlist_name <- "2014 Playlist"
playlist_tracks_2015$playlist_name <- "2015 Playlist"
playlist_tracks_2016$playlist_name <- "2016 Playlist"
playlist_tracks_2017$playlist_name <- "2017 Playlist"
playlist_tracks_2018$playlist_name <- "2018 Playlist"
playlist_tracks_2020$playlist_name <- "2020 Playlist"
playlist_tracks_2021$playlist_name <- "2021 Playlist"
playlist_tracks_2022$playlist_name <- "2022 Playlist"
playlist_tracks_2023$playlist_name <- "2023 Playlist"
playlist_tracks_2024$playlist_name <- "2024 Playlist"
playlist_tracks_2025$playlist_name <- "2025 Playlist"

# Add year too, as you already did
playlist_tracks_2014$year <- 2014
playlist_tracks_2015$year <- 2015
playlist_tracks_2016$year <- 2016
playlist_tracks_2017$year <- 2017
playlist_tracks_2018$year <- 2018
playlist_tracks_2020$year <- 2020
playlist_tracks_2021$year <- 2021
playlist_tracks_2022$year <- 2022
playlist_tracks_2023$year <- 2023
playlist_tracks_2024$year <- 2024
playlist_tracks_2025$year <- 2025

# Now combine all playlists
all_tracks <- bind_rows(
  playlist_tracks_2014,
  playlist_tracks_2015,
  playlist_tracks_2016,
  playlist_tracks_2017,
  playlist_tracks_2018,
  playlist_tracks_2020,
  playlist_tracks_2021,
  playlist_tracks_2022,
  playlist_tracks_2023,
  playlist_tracks_2024,
  playlist_tracks_2025
)
```

# 1
```{r}
all_tracks <- all_tracks |>
  mutate(album_release_date = as.Date(album_release_date),
         playlist_name = as.factor(playlist_name))

plot_ly(
  data = all_tracks,
  x = ~album_release_date,
  y = ~popularity,
  color = ~playlist_name,
  type = 'scatter',
  mode = 'markers',
  text = ~paste(track_name, "<br>Artist:", artist_name, "<br>Album:", album_name, "<br>Popularity:", popularity),
  hoverinfo = 'text',
  marker = list(size = 8)
) |>
  layout(
    title = "Track Popularity Over Release Dates",
    xaxis = list(title = "Album Release Date"),
    yaxis = list(title = "Track Popularity", range = c(0, 100)),
    hovermode = "closest"
  )
```

# 3
```{r}
library(dplyr)
library(plotly)

# Calculate % of explicit tracks per year
explicit_summary <- all_tracks %>%
  group_by(year) %>%
  summarize(
    total_tracks = n(),
    explicit_tracks = sum(track_explicit),
    percent_explicit = round((explicit_tracks / total_tracks) * 100, 1)
  )

# Plot using plotly
plot_ly(
  data = explicit_summary,
  x = ~year,
  y = ~percent_explicit,
  type = 'bar',
  text = ~paste(percent_explicit, "% explicit"),
  textposition = 'auto',
  marker = list(color = 'firebrick')
) |>
  layout(
    title = "Share of Explicit Tracks in Top Hit Playlists (2014–2025)",
    xaxis = list(title = "Year"),
    yaxis = list(title = "Percent Explicit Tracks", range = c(0, 100)),
    bargap = 0.2
  )
```

# 4
```{r}
library(dplyr)
library(plotly)

# Count how often each artist appears
top_artists <- all_tracks %>%
  count(artist_name, sort = TRUE) %>%
  top_n(15, n) %>%
  arrange(n)  # So they appear from least to most in the horizontal bar

# Plot
plot_ly(
  data = top_artists,
  x = ~n,
  y = ~reorder(artist_name, n),
  type = 'bar',
  orientation = 'h',
  text = ~paste(n, "tracks"),
  textposition = 'auto',
  marker = list(color = 'steelblue')
) %>%
  layout(
    title = "Top 15 Most Featured Artists in Spotify Top Hit Playlists (2014–2025)",
    xaxis = list(title = "Number of Tracks"),
    yaxis = list(title = "Artist"),
    margin = list(l = 150)
  )
```


```{r}
library(shiny)
library(tidyverse)
library(spotifyr)
library(httr2)
library(DT)


token <- get_spotify_token(client_id, client_secret)

# Function to retrieve metadata for a list of artists
get_artists_data <- function(artist_ids, token) {
  artist_chunks <- split(artist_ids, ceiling(seq_along(artist_ids) / 50))

  map_dfr(artist_chunks, function(ids_chunk) {
    req <- request("https://api.spotify.com/v1/artists") |>
      req_url_query(ids = paste(ids_chunk, collapse = ",")) |>
      req_headers(Authorization = paste("Bearer", token))

    resp <- req_perform(req)
    content <- resp_body_json(resp, simplifyVector = FALSE)

    map_dfr(content$artists, function(artist) {
      tibble(
        artist_id = artist$id,
        artist_name = artist$name,
        genres = paste(artist$genres, collapse = ", "),
        popularity = artist$popularity,
        followers = artist$followers$total,
        artist_url = artist$external_urls$spotify
      )
    })
  })
}

# Function to get top tracks for a selected artist
get_artist_top_tracks <- function(artist_id, token) {
  url <- paste0("https://api.spotify.com/v1/artists/", artist_id, "/top-tracks?market=US")
  
  req <- request(url) |>
    req_headers(Authorization = paste("Bearer", token))
  
  resp <- req_perform(req)
  content <- resp_body_json(resp, simplifyVector = FALSE)
  
  map_dfr(content$tracks, function(track) {
    tibble(
      track_name = track$name,
      album_name = track$album$name,
      popularity = track$popularity,
      track_duration_ms = track$duration_ms
    )
  })
}

# Define popular artist Spotify IDs
artist_ids <- c(
  "06HL4z0CvFAxyc27GXpf02",  # Taylor Swift
  "1Xyo4u8uXC1ZmMpatF05PJ",  # The Weeknd
  "4q3ewBCX7sLwd24euuV69X",  # Bad Bunny
  "3TVXtAsR1Inumwj472S9r4",  # Drake
  "6qqNVTkY8uBg9cP3Jd7DAH",  # Billie Eilish
  "0Y5tJX1MQlPlqiwlOH1tJY",  # Travis Scott
  "12GqGscKJx3aE4t07u7eVZ",  # Peso Pluma
  "5K4W6rqBFWDnAN6FQUkS6x",  # Kanye West
  "66CXWjxzNUsdJxJ2JdwvnR",  # Ariana Grande
  "2LRoIwlKmHjgvigdNGBHNo"   # Feid
)

artists_data <- get_artists_data(artist_ids, token)
artist_choices <- setNames(artists_data$artist_id, artists_data$artist_name)
```

# combined
```{r}
# Create a dataframe with top tracks for each artist, with artist name included
top_artist_tracks <- map_dfr(artist_ids, function(id) {
  artist_tracks <- get_artist_top_tracks(id, token)
  artist_name <- get_artists_data(id, token)$artist_name  # pull artist name from metadata
  artist_tracks |> mutate(artist_id = id, artist_name = artist_name)
})
```

```{r}
# Make sure all_tracks exists and is cleaned
all_tracks <- all_tracks |>
  mutate(album_release_date = as.Date(album_release_date),
         playlist_name = as.factor(playlist_name))

# Combine datasets
combined_tracks <- bind_rows(
  all_tracks |> mutate(source = "Playlist"),
  top_artist_tracks |> mutate(source = "Top Artist")
)
```





